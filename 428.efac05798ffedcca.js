"use strict";(self.webpackChunkhedge_accounting_sfx=self.webpackChunkhedge_accounting_sfx||[]).push([[428],{2428:(A,h,a)=>{a.r(h),a.d(h,{BufferConfigurationComponent:()=>S});var u=a(467),b=a(177),f=a(4341),C=a(9641),v=a(1141),w=a(2242),c=a(8833),_=a(1570),e=a(4438),M=a(4412),g=a(7129);let F=(()=>{class l{constructor(){this.subject=new M.t([]),this.rows$=this.subject.asObservable(),this.fetch(),this.subscribeRealtime()}fetch(){var i=this;return(0,u.A)(function*(){try{const r=(0,g.b)(),{data:t,error:o}=yield r.from("buffer_configuration").select("*");!o&&t?i.subject.next(t):o&&console.error("Error loading buffer_configuration:",o)}catch(r){console.warn("Supabase unavailable for buffer_configuration.fetch()",r)}})()}subscribeRealtime(){try{const i=(0,g.b)();this.channel=i.channel("buffer_configuration_changes").on("postgres_changes",{event:"*",schema:"public",table:"buffer_configuration"},()=>{this.fetch()}).subscribe()}catch(i){console.warn("Supabase realtime unavailable for buffer_configuration",i)}}add(i){return(0,u.A)(function*(){const r=(new Date).toISOString();try{yield(0,g.b)().from("buffer_configuration").insert([{...i,created_date:i.created_date||r,modified_date:i.modified_date||r}])}catch(t){throw console.error("Error adding buffer_configuration row:",t),t}})()}update(i,r){return(0,u.A)(function*(){const t=(new Date).toISOString();try{yield(0,g.b)().from("buffer_configuration").update({...r,modified_date:t}).eq("buffer_rule_id",i)}catch(o){throw console.error("Error updating buffer_configuration row:",o),o}})()}delete(i){return(0,u.A)(function*(){try{yield(0,g.b)().from("buffer_configuration").delete().eq("buffer_rule_id",i)}catch(r){throw console.error("Error deleting buffer_configuration row:",r),r}})()}static{this.\u0275fac=function(r){return new(r||l)}}static{this.\u0275prov=e.jDH({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();var k=a(2316),R=a(5032),E=a(5779);const j=()=>({width:"100vw",height:"95vh","max-width":"100vw","max-height":"95vh","border-top-left-radius":"16px","border-top-right-radius":"16px"}),p=()=>({width:"100%"}),D=()=>({label:"Active",value:"Y"}),B=()=>({label:"Inactive",value:"N"}),T=(l,y)=>[l,y];function I(l,y){if(1&l){const i=e.RV6();e.j41(0,"div",46)(1,"button",47),e.bIt("click",function(){e.eBV(i);const t=e.XpG();return e.Njj(t.showDialog=!1)}),e.EFF(2,"Cancel"),e.k0s(),e.j41(3,"button",5),e.bIt("click",function(){e.eBV(i);const t=e.XpG();return e.Njj(t.confirmSave())}),e.EFF(4),e.k0s()()}if(2&l){const i=e.XpG();e.R7$(4),e.JRh("edit"===i.mode?"Update":"Save")}}let S=(()=>{class l{constructor(i,r,t,o){this.ngZone=i,this.svc=r,this.entitySvc=t,this.frameworkSvc=o,this.defaultColDef={resizable:!0,sortable:!0,filter:"agSetColumnFilter",minWidth:100},this.columnDefs=[{field:"buffer_rule_id",headerName:"Rule ID",minWidth:150,sortable:!0},{field:"entity_type",headerName:"Entity Type",width:140,sortable:!0},{field:"entity_id",headerName:"Entity ID",width:160,sortable:!0},{field:"currency_code",headerName:"Currency",width:100,sortable:!0},{field:"hedging_framework",headerName:"Framework",width:140,sortable:!0},{field:"minimum_buffer_amount",headerName:"Min Buffer",width:140,type:"numericColumn"},{field:"maximum_buffer_amount",headerName:"Max Buffer",width:140,type:"numericColumn"},{field:"buffer_percentage",headerName:"Buffer %",width:110,type:"numericColumn"},{field:"active_flag",headerName:"Status",width:110,cellRenderer:n=>{const s="Y"===(n.value||"").toUpperCase()?"Active":"Inactive",m="Active"===s?"bg-green-100 text-green-800":"bg-red-100 text-red-800",d=document.createElement("span");return d.className=`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${m}`,d.textContent=s,d}},{field:"effective_date",headerName:"Effective",width:130,sortable:!0},{field:"expiry_date",headerName:"Expiry",width:130,sortable:!0},{field:"rule_priority",headerName:"Priority",width:110,type:"numericColumn"},{field:"nav_type_priority",headerName:"NAV Priority",width:140},{headerName:"Actions",width:120,pinned:"right",cellRenderer:n=>{const s=document.createElement("div");s.className="flex items-center justify-center space-x-2";const m=document.createElement("button");m.className="text-gray-500 hover:text-blue-600 p-1",m.title="Edit Buffer Rule",m.innerHTML='<i class="pi pi-pencil text-sm"></i>',m.addEventListener("click",()=>n.context.componentParent.editRow(n.data));const d=document.createElement("button");return d.className="text-gray-500 hover:text-red-600 p-1",d.title="Delete Buffer Rule",d.innerHTML='<i class="pi pi-trash text-sm"></i>',d.addEventListener("click",()=>n.context.componentParent.deleteRow(n.data)),s.appendChild(m),s.appendChild(d),s}}],this.gridOptions={pagination:!0,paginationPageSize:20,animateRows:!0,context:{componentParent:this}},this.rows=[],this.search="",this.showDialog=!1,this.mode="add",this.form={},this.entityTypeOptions=[],this.entityIdOptions=[],this.latestEntities=[],this.hedgingFrameworkOptions=[],this.frameworksCache=[]}ngOnInit(){this.sub=this.svc.rows$.subscribe(i=>{this.rows=i,setTimeout(()=>this.gridApi?.sizeColumnsToFit(),0)}),this.entitiesSub=this.entitySvc.entities$.subscribe(i=>{this.latestEntities=i||[];const r=Array.from(new Set(this.latestEntities.map(t=>t.entity_type).filter(Boolean)));this.entityTypeOptions=r.map(t=>({label:t,value:t})),this.form.entity_type&&this.refreshEntityIds(this.latestEntities,this.form.entity_type)}),this.loadFrameworkOptions()}ngOnDestroy(){this.sub&&this.sub.unsubscribe(),this.entitiesSub&&this.entitiesSub.unsubscribe()}onGridReady(i){this.gridApi=i.api,i.api.sizeColumnsToFit()}onSearchChange(i){this.search=i,this.searchTimer&&clearTimeout(this.searchTimer),this.searchTimer=setTimeout(()=>this.applyFilters(),300)}applyFilters(){let i=this.rows;if(this.search.trim()){const r=this.search.trim().toLowerCase();i=i.filter(t=>t.buffer_rule_id?.toLowerCase().includes(r)||t.entity_id?.toLowerCase().includes(r)||t.entity_type?.toLowerCase().includes(r)||t.currency_code?.toLowerCase().includes(r)||t.hedging_framework?.toLowerCase().includes(r))}this.gridApi?.setRowData(i),setTimeout(()=>this.gridApi?.sizeColumnsToFit(),0)}openAdd(){this.mode="add",this.form={active_flag:"Y",buffer_percentage:0,rule_priority:1},this.ngZone.run(()=>this.showDialog=!0)}editRow(i){this.mode="edit",this.form={...i},this.ngZone.run(()=>this.showDialog=!0)}deleteRow(i){var r=this;return(0,u.A)(function*(){i?.buffer_rule_id&&confirm("Delete this buffer rule?")&&(yield r.svc.delete(i.buffer_rule_id))})()}confirmSave(){var i=this;return(0,u.A)(function*(){"edit"===i.mode&&i.form.buffer_rule_id?yield i.svc.update(i.form.buffer_rule_id,i.form):yield i.svc.add(i.form),i.showDialog=!1,i.mode="add",i.form={}})()}onEntityTypeChange(i){this.refreshEntityIds(this.latestEntities,i),this.form.entity_id="",this.refreshFrameworkOptions()}onEntityChange(i){this.form.entity_id=i,this.refreshFrameworkOptions()}refreshEntityIds(i,r){const t=(i||[]).filter(o=>!r||o.entity_type===r);this.entityIdOptions=t.map(o=>({label:`${o.entity_name} (${o.legal_entity_code})`,value:o.legal_entity_code}))}loadFrameworkOptions(){var i=this;return(0,u.A)(function*(){try{const r=yield i.frameworkSvc.list({});i.frameworksCache=r||[],i.refreshFrameworkOptions()}catch(r){console.error("Failed to load hedging frameworks",r),i.frameworksCache=[],i.hedgingFrameworkOptions=[]}})()}refreshFrameworkOptions(){const i=this.form.entity_id,r=i?this.frameworksCache.filter(n=>(n.entity_id||"")===i):this.frameworksCache,t=new Set,o=[];for(const n of r){const s=(n.hedging_state||"").trim();!s||t.has(s)||(t.add(s),o.push({label:s,value:s}))}this.hedgingFrameworkOptions=o}static{this.\u0275fac=function(r){return new(r||l)(e.rXU(e.SKi),e.rXU(F),e.rXU(k.r),e.rXU(R.i))}}static{this.\u0275cmp=e.VBU({type:l,selectors:[["app-config-buffer-configuration"]],standalone:!0,features:[e.aNF],decls:127,vars:51,consts:[[1,"p-6"],[1,"mb-6"],[1,"flex","justify-between","items-center"],[1,"text-xl","font-semibold","text-gray-900","mb-2"],[1,"text-gray-600"],[1,"btn","btn-primary",3,"click"],[1,"pi","pi-plus"],[1,"flex","items-center","gap-4","mb-4"],[1,"flex-1","flex","items-center","gap-2"],[1,"filter-label"],["type","text","placeholder","Search rule id, entity, currency...",1,"filter-input","flex-1","max-w-xs",3,"ngModelChange","ngModel"],[1,"bg-white","rounded-lg","shadow-sm","border","border-gray-200"],[1,"ag-theme-alpine","w-full",2,"height","600px",3,"gridReady","columnDefs","rowData","defaultColDef","gridOptions"],["styleClass","entity-dialog entity-dialog-full",3,"visibleChange","header","visible","modal","closable"],[1,"space-y-6","p-2"],[1,"rounded-lg","border","border-gray-200","p-4","bg-white"],[1,"grid","grid-cols-12","gap-4"],[1,"col-span-12","md:col-span-3","flex","items-center"],[1,"text-sm","font-semibold","text-gray-700"],[1,"col-span-12","md:col-span-9"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],[1,"field"],[1,"block","text-sm","font-medium","text-gray-700","mb-1"],["type","text","name","buffer_rule_id","placeholder","Unique rule id",1,"filter-input","w-full",3,"ngModelChange","ngModel","readonly"],["name","entity_type","placeholder","Select entity type","styleClass","filter-input w-full",3,"ngModelChange","onChange","options","ngModel"],["name","entity_id","placeholder","Select entity","styleClass","filter-input w-full",3,"ngModelChange","onChange","options","ngModel"],["type","text","name","currency_code","placeholder","e.g., USD",1,"filter-input","w-full",3,"ngModelChange","ngModel"],["name","hedging_framework","placeholder","Select framework","styleClass","filter-input w-full",3,"ngModelChange","options","ngModel"],["name","active_flag","placeholder","Select status","styleClass","filter-input w-full",3,"ngModelChange","options","ngModel"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-4"],["type","number","name","minimum_buffer_amount",1,"filter-input","w-full",3,"ngModelChange","ngModel"],["type","number","name","maximum_buffer_amount",1,"filter-input","w-full",3,"ngModelChange","ngModel"],["type","number","name","buffer_percentage",1,"filter-input","w-full",3,"ngModelChange","ngModel"],["type","date","name","effective_date",1,"filter-input","w-full",3,"ngModelChange","ngModel"],["type","date","name","expiry_date",1,"filter-input","w-full",3,"ngModelChange","ngModel"],["type","number","name","rule_priority",1,"filter-input","w-full",3,"ngModelChange","ngModel"],["type","text","name","nav_type_priority","placeholder","e.g., Trading>Investment",1,"filter-input","w-full",3,"ngModelChange","ngModel"],["name","car_exemption_flag",1,"filter-input","w-full",3,"ngModelChange","ngModel"],[3,"ngValue"],["value","Y"],["value","N"],[1,"field","md:col-span-2"],["type","text","name","buffer_allocation_method","placeholder","e.g., proportional",1,"filter-input","w-full",3,"ngModelChange","ngModel"],[1,"grid","grid-cols-1","gap-4"],["type","text","name","business_rule_description","placeholder","Short description",1,"filter-input","w-full",3,"ngModelChange","ngModel"],["pTemplate","footer"],[1,"flex","justify-end","space-x-3","pt-4","border-t","border-gray-200"],[1,"btn","btn-secondary",3,"click"]],template:function(r,t){1&r&&(e.j41(0,"div",0)(1,"div",1)(2,"div",2)(3,"div")(4,"h2",3),e.EFF(5,"Buffer Configuration"),e.k0s(),e.j41(6,"p",4),e.EFF(7,"Manage buffer rules and allocations"),e.k0s()(),e.j41(8,"button",5),e.bIt("click",function(){return t.openAdd()}),e.nrm(9,"i",6),e.j41(10,"span"),e.EFF(11,"Add Buffer Rule"),e.k0s()()()(),e.j41(12,"div",7)(13,"div",8)(14,"label",9),e.EFF(15,"Search:"),e.k0s(),e.j41(16,"input",10),e.mxI("ngModelChange",function(n){return e.DH7(t.search,n)||(t.search=n),n}),e.bIt("ngModelChange",function(n){return t.onSearchChange(n)}),e.k0s()()(),e.j41(17,"div",11)(18,"ag-grid-angular",12),e.bIt("gridReady",function(n){return t.onGridReady(n)}),e.k0s()(),e.j41(19,"p-dialog",13),e.mxI("visibleChange",function(n){return e.DH7(t.showDialog,n)||(t.showDialog=n),n}),e.j41(20,"form",14)(21,"div",15)(22,"div",16)(23,"div",17)(24,"div",18),e.EFF(25,"Basic Info"),e.k0s()(),e.j41(26,"div",19)(27,"div",20)(28,"div",21)(29,"label",22),e.EFF(30,"Rule ID"),e.k0s(),e.j41(31,"input",23),e.mxI("ngModelChange",function(n){return e.DH7(t.form.buffer_rule_id,n)||(t.form.buffer_rule_id=n),n}),e.k0s()(),e.j41(32,"div",21)(33,"label",22),e.EFF(34,"Entity Type"),e.k0s(),e.j41(35,"p-dropdown",24),e.mxI("ngModelChange",function(n){return e.DH7(t.form.entity_type,n)||(t.form.entity_type=n),n}),e.bIt("onChange",function(n){return t.onEntityTypeChange(n.value)}),e.k0s()(),e.j41(36,"div",21)(37,"label",22),e.EFF(38,"Entity"),e.k0s(),e.j41(39,"p-dropdown",25),e.mxI("ngModelChange",function(n){return e.DH7(t.form.entity_id,n)||(t.form.entity_id=n),n}),e.bIt("onChange",function(n){return t.onEntityChange(n.value)}),e.k0s()(),e.j41(40,"div",21)(41,"label",22),e.EFF(42,"Currency Code"),e.k0s(),e.j41(43,"input",26),e.mxI("ngModelChange",function(n){return e.DH7(t.form.currency_code,n)||(t.form.currency_code=n),n}),e.k0s()(),e.j41(44,"div",21)(45,"label",22),e.EFF(46,"Hedge State"),e.k0s(),e.j41(47,"p-dropdown",27),e.mxI("ngModelChange",function(n){return e.DH7(t.form.hedging_framework,n)||(t.form.hedging_framework=n),n}),e.k0s()(),e.j41(48,"div",21)(49,"label",22),e.EFF(50,"Active"),e.k0s(),e.j41(51,"p-dropdown",28),e.mxI("ngModelChange",function(n){return e.DH7(t.form.active_flag,n)||(t.form.active_flag=n),n}),e.k0s()()()()()(),e.j41(52,"div",15)(53,"div",16)(54,"div",17)(55,"div",18),e.EFF(56,"Amounts & Percentage"),e.k0s()(),e.j41(57,"div",19)(58,"div",29)(59,"div",21)(60,"label",22),e.EFF(61,"Minimum Buffer Amount"),e.k0s(),e.j41(62,"input",30),e.mxI("ngModelChange",function(n){return e.DH7(t.form.minimum_buffer_amount,n)||(t.form.minimum_buffer_amount=n),n}),e.k0s()(),e.j41(63,"div",21)(64,"label",22),e.EFF(65,"Maximum Buffer Amount"),e.k0s(),e.j41(66,"input",31),e.mxI("ngModelChange",function(n){return e.DH7(t.form.maximum_buffer_amount,n)||(t.form.maximum_buffer_amount=n),n}),e.k0s()(),e.j41(67,"div",21)(68,"label",22),e.EFF(69,"Buffer Percentage"),e.k0s(),e.j41(70,"input",32),e.mxI("ngModelChange",function(n){return e.DH7(t.form.buffer_percentage,n)||(t.form.buffer_percentage=n),n}),e.k0s()()()()()(),e.j41(71,"div",15)(72,"div",16)(73,"div",17)(74,"div",18),e.EFF(75,"Dates"),e.k0s()(),e.j41(76,"div",19)(77,"div",20)(78,"div",21)(79,"label",22),e.EFF(80,"Effective Date"),e.k0s(),e.j41(81,"input",33),e.mxI("ngModelChange",function(n){return e.DH7(t.form.effective_date,n)||(t.form.effective_date=n),n}),e.k0s()(),e.j41(82,"div",21)(83,"label",22),e.EFF(84,"Expiry Date"),e.k0s(),e.j41(85,"input",34),e.mxI("ngModelChange",function(n){return e.DH7(t.form.expiry_date,n)||(t.form.expiry_date=n),n}),e.k0s()()()()()(),e.j41(86,"div",15)(87,"div",16)(88,"div",17)(89,"div",18),e.EFF(90,"Rules & Flags"),e.k0s()(),e.j41(91,"div",19)(92,"div",20)(93,"div",21)(94,"label",22),e.EFF(95,"Rule Priority"),e.k0s(),e.j41(96,"input",35),e.mxI("ngModelChange",function(n){return e.DH7(t.form.rule_priority,n)||(t.form.rule_priority=n),n}),e.k0s()(),e.j41(97,"div",21)(98,"label",22),e.EFF(99,"NAV Type Priority"),e.k0s(),e.j41(100,"input",36),e.mxI("ngModelChange",function(n){return e.DH7(t.form.nav_type_priority,n)||(t.form.nav_type_priority=n),n}),e.k0s()(),e.j41(101,"div",21)(102,"label",22),e.EFF(103,"CAR Exemption"),e.k0s(),e.j41(104,"select",37),e.mxI("ngModelChange",function(n){return e.DH7(t.form.car_exemption_flag,n)||(t.form.car_exemption_flag=n),n}),e.j41(105,"option",38),e.EFF(106,"--"),e.k0s(),e.j41(107,"option",39),e.EFF(108,"Y"),e.k0s(),e.j41(109,"option",40),e.EFF(110,"N"),e.k0s()()(),e.j41(111,"div",41)(112,"label",22),e.EFF(113,"Buffer Allocation Method"),e.k0s(),e.j41(114,"input",42),e.mxI("ngModelChange",function(n){return e.DH7(t.form.buffer_allocation_method,n)||(t.form.buffer_allocation_method=n),n}),e.k0s()()()()()(),e.j41(115,"div",15)(116,"div",16)(117,"div",17)(118,"div",18),e.EFF(119,"Business Rule"),e.k0s()(),e.j41(120,"div",19)(121,"div",43)(122,"div",21)(123,"label",22),e.EFF(124,"Description"),e.k0s(),e.j41(125,"input",44),e.mxI("ngModelChange",function(n){return e.DH7(t.form.business_rule_description,n)||(t.form.business_rule_description=n),n}),e.k0s()()()()()()(),e.DNE(126,I,5,1,"ng-template",45),e.k0s()()),2&r&&(e.R7$(16),e.R50("ngModel",t.search),e.R7$(2),e.Y8G("columnDefs",t.columnDefs)("rowData",t.rows)("defaultColDef",t.defaultColDef)("gridOptions",t.gridOptions),e.R7$(),e.Aen(e.lJ4(41,j)),e.FS9("header","edit"===t.mode?"Edit Buffer Rule":"Add Buffer Rule"),e.R50("visible",t.showDialog),e.Y8G("modal",!0)("closable",!0),e.R7$(12),e.R50("ngModel",t.form.buffer_rule_id),e.Y8G("readonly","edit"===t.mode),e.R7$(4),e.Aen(e.lJ4(42,p)),e.Y8G("options",t.entityTypeOptions),e.R50("ngModel",t.form.entity_type),e.R7$(4),e.Aen(e.lJ4(43,p)),e.Y8G("options",t.entityIdOptions),e.R50("ngModel",t.form.entity_id),e.R7$(4),e.R50("ngModel",t.form.currency_code),e.R7$(4),e.Aen(e.lJ4(44,p)),e.Y8G("options",t.hedgingFrameworkOptions),e.R50("ngModel",t.form.hedging_framework),e.R7$(4),e.Aen(e.lJ4(45,p)),e.Y8G("options",e.l_i(48,T,e.lJ4(46,D),e.lJ4(47,B))),e.R50("ngModel",t.form.active_flag),e.R7$(11),e.R50("ngModel",t.form.minimum_buffer_amount),e.R7$(4),e.R50("ngModel",t.form.maximum_buffer_amount),e.R7$(4),e.R50("ngModel",t.form.buffer_percentage),e.R7$(11),e.R50("ngModel",t.form.effective_date),e.R7$(4),e.R50("ngModel",t.form.expiry_date),e.R7$(11),e.R50("ngModel",t.form.rule_priority),e.R7$(4),e.R50("ngModel",t.form.nav_type_priority),e.R7$(4),e.R50("ngModel",t.form.car_exemption_flag),e.R7$(),e.Y8G("ngValue",void 0),e.R7$(9),e.R50("ngModel",t.form.buffer_allocation_method),e.R7$(11),e.R50("ngModel",t.form.business_rule_description))},dependencies:[b.MD,f.YN,f.qT,f.xH,f.y7,f.me,f.Q0,f.wz,f.BC,f.cb,f.vS,f.cV,C.xs,v.tm,E.Ei,w.u,c.kr,c.ms,_.P,_.l],encapsulation:2})}}return l})()}}]);